<html layout:decorate="~{layout/layout}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head><title>회원가입</title></head>

<div layout:fragment="content" class="min-h-screen flex flex-col items-center gap-12">

    <!-- 이곳에 로직을 구현해주시면 됩니다 -->
    <script>
        emailConfirmCheck = false;

        function JoinForm__submit(form) {
            // username 이(가) 올바른지 체크

            form.username.value = form.username.value.trim(); // 입력란의 입력값에 있을지 모르는 좌우공백제거

            if (form.username.value.length == 0) {
                toastWarning('아이디를 입력해주세요.');
                form.username.focus();
                return;
            }

            if (form.username.value.length < 4) {
                toastWarning('아이디를 4자 이상 입력해주세요.');
                form.username.focus();
                return;
            }

            // password 이(가) 올바른지 체크

            form.password.value = form.password.value.trim(); // 입력란의 입력값에 있을지 모르는 좌우공백제거

            if (form.password.value.length == 0) {
                form.password.focus();
                toastWarning('비밀번호를 입력해주세요.');
                return;
            }

            if (form.password.value.length < 4) {
                toastWarning('비밀번호를 4자 이상 입력해주세요.');
                form.password.focus();
                return;
            }

            // email 이(가) 올바른지 체크

            form.email.value = form.email.value.trim(); // 입력란의 입력값에 있을지 모르는 좌우공백제거

            if (form.email.value.length == 0) {
                form.email.focus();
                toastWarning('이메일을 입력해주세요.');
                return;
            }

            // 인증번호 이(가) 올바른지 체크

            form.code.value = form.code.value.trim(); // 입력란의 입력값에 있을지 모르는 좌우공백제거

            if (form.code.value.length == 0) {
                toastWarning('인증번호를 입력해주세요.');
                form.code.focus();
                return;
            }

            if (form.code.value.length != 8) {
                toastWarning('인증번호는 8자리입니다.');
                form.code.focus();
                return;
            }

            if (emailConfirmCheck == false) {
                toastWarning('인증번호가 잘못되었습니다.');
                form.code.focus();
                return;
            }

            // 닉네임 이(가) 올바른지 체크

            form.nickname.value = form.nickname.value.trim(); // 입력란의 입력값에 있을지 모르는 좌우공백제거

            if (form.nickname.value.length == 0) {
                toastWarning('닉네임을 입력해주세요.');
                form.nickname.focus();
                return;
            }

            if (form.nickname.value.length < 4) {
                toastWarning('닉네임을 4자 이상 입력해주세요.');
                form.nickname.focus();
                return;
            }

            form.submit(); // 폼 발송
        }

        $(function() {
            var $email = $("#email");
            var $checkEmail = $("#checkEmail"); // 인증번호 발송 버튼
            var $emailConfirm = $("#emailConfirm"); // 인증번호 확인input
            var $emailConfirmTxt = $("#emailConfirmTxt"); // 인증번호 확인 txt

            // 이메일 인증번호
            $checkEmail.click(function () {
                $.ajax({
                    type: "POST",
                    url: "/member/login/mailConfirm",
                    data: {
                        "email": $email.val()
                    },
                    success: function (data) {
                        toastNotice('해당 이메일로 인증번호 발송이 완료되었습니다.<br>확인부탁드립니다.');
                        console.log("data : " + data);
                        $("#emailConfirm").prop("disabled", false);
                        chkEmailConfirm(data, $emailConfirm, $emailConfirmTxt);
                    },
                    error: function() {
                        toastWarning('인증번호 발송에 실패했습니다.<br>다시 시도해주세요.');
                        console.log("Error: 유효하지 않은 이메일입니다.");
                    }
                })
            })

            // 이메일 인증번호 체크 함수
            function chkEmailConfirm(data, $emailConfirm, $emailConfirmTxt) {
                $emailConfirm.on("keyup", function () {
                    if (data != $emailConfirm.val()) { //
                        emailConfirmCheck = false;
                        $emailConfirmTxt.html("<span id='emailConfirmCheck'>인증번호가 잘못되었습니다</span>")
                        $("#emailConfirmCheck").css({
                            "color": "#FA3E3E",
                            "font-weight": "bold",
                            "font-size": "10px"

                        })
                        //console.log("중복아이디");
                    } else { // 아니면 중복아님
                        emailConfirmCheck = true;
                        $emailConfirmTxt.html("<span id='emailConfirmCheck'>인증번호 확인 완료</span>")

                        $("#emailConfirmCheck").css({
                            "color": "#0D6EFD",
                            "font-weight": "bold",
                            "font-size": "10px"

                        })
                    }
                })
            }
        });
    </script>
    <script>
        function checkDuplicate(field) {
            var inputId = field + 'Input';
            var messageLabelId = field + 'Message';
            var value = document.getElementById(inputId).value;
            var messageLabel = document.getElementById(messageLabelId);

            // 공백 입력 검증
            if (value.trim() === '') {
                messageLabel.innerHTML = '입력해주세요.';
                messageLabel.style.color = '#FA3E3E';
                return; // 검증 실패 시 함수 종료
            }

            // 글자수 입력 검증
            if (value.trim().length < 4) {
                messageLabel.innerHTML = '4글자 이상 입력해주세요.';
                messageLabel.style.color = '#FA3E3E';
                return; // 검증 실패 시 함수 종료
            }

            // AJAX 요청 보내기
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        var messageLabel = document.getElementById(messageLabelId);
                        messageLabel.innerHTML = response.message;

                        // 사용 가능 여부에 따라 텍스트 색상 변경
                        if (response.message === '사용 가능한 ' + field + '입니다.') {
                            messageLabel.style.color = '#0D6EFD';
                        } else {
                            messageLabel.style.color = '#FA3E3E';
                        }
                    }
                }
            };

            xhr.open('POST', '/member/checkDuplicate/' + field, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({ value: value }));
        }
    </script>

    <div class="flex flex-col justify-center items-center">

        <div class="stats stats-vertical shadow max-w-2xl">

            <div class="stat">
                <div class="stat-title text-xl">
                    <i class="fa-solid fa-user-plus mr-2"></i>회원가입
                </div>
            </div>
        </div>
        <form th:action method="POST" class="p-10 flex flex-col gap-4" onsubmit="JoinForm__submit(this); return false;">
            <div class="mb-3">
                <div class="flex gap-2 items-center">
                    <input type="text" name="username" id="usernameInput" maxlength="30" placeholder="아이디를 입력해주세요." class="input input-bordered">
                    <button class="btn btn-accent btn-xs" type="button" onclick="checkDuplicate('username')">중복확인</button>
                </div>
                <label for="usernameInput" id="usernameMessage">아이디를 입력해주세요.</label>
            </div>
            <div class="mb-3">
                <input type="password" name="password" maxlength="30" placeholder="비밀번호를 입력해주세요." class="input input-bordered">
            </div>
            <div class="flex gap-2 items-center">
                <input type="text" class="input input-bordered" name="email" id="email" placeholder="이메일을 입력해주세요.">
                <button class="btn btn-accent btn-xs" type="button" id="checkEmail">인증하기</button>
            </div>
            <div class="flex flex-col">
                <input type="text" class="input input-bordered" name="code" id="emailConfirm" placeholder="인증번호는 8자리 입니다." disabled>
                <label for="emailConfirm" id="emailConfirmTxt">
                    <span id="emailConfirmCheck-before">인증번호를 입력해주세요.</span>
                </label>
            </div>
            <div class="mb-3">
                <div class="flex gap-2 items-center">
                    <input type="text" name="nickname" id="nicknameInput" maxlength="30" placeholder="닉네임를 입력해주세요." class="input input-bordered">
                    <button class="btn btn-accent btn-xs" type="button" onclick="checkDuplicate('nickname')">중복확인</button>
                </div>
                <label for="nicknameInput" id="nicknameMessage">닉네임을 입력해주세요.</label>
            </div>
            <div class="mb-1">
                <input type="submit" value="가입완료" class="btn btn-block btn-primary">
            </div>
        </form>
    </div>

</div>
</html>